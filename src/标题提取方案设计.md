# 智能标题提取方案设计

## 方案概述

基于**多特征评分系统**的智能标题识别方案，而非简单的文本模式堆砌匹配。

## 核心思想

通过分析标题的**多维特征**，构建综合评分模型，自动识别文档中的各级标题（最小粒度）。

## 标题特征分析

### 1. 字体格式特征
- **字号层次**：
  - 章节标题：22-24pt
  - 一级标题（一、二、三...）：17-18pt
  - 二级标题（1.2.3...）：14-16pt
  - 三级标题（1.1 1.2...）：12-14pt
- **加粗状态**：通常为True
- **字体一致性**：同一级别标题的字体特征相似

### 2. 文本模式特征（作为辅助验证）
- 章节模式：`第[一二三四五六七八九十]+章`
- 中文数字：`^[一二三四五六七八九十]+、`
- 阿拉伯数字：`^[0-9]+[、.]`
- 格式标题：`^格式[一二三四五六七八九十]+`
- 表格标题：`^(表|附表)[一二三四五六七八九十]+：`

### 3. 结构位置特征
- 段落独立：标题前后通常有空行
- 简短性：标题通常较短（<100字符）
- 层次关系：通过缩进或编号体现层级

## 评分系统设计

### 特征权重分配

| 特征维度 | 权重 | 评分标准 |
|---------|------|---------|
| 字体大小 | 40% | 字号越大，分数越高 |
| 加粗状态 | 20% | 加粗得满分，否则0分 |
| 文本模式 | 25% | 匹配标题模式的数量和优先级 |
| 段落长度 | 10% | 简短文本（<30字符）得分高 |
| 格式一致性 | 5% | 与同级标题格式相似度高 |

### 评分算法

```python
def calculate_title_score(paragraph, context):
    """
    计算段落作为标题的综合评分
    
    Returns:
        float: 0-100之间的分数
        str: 推测的标题级别
    """
    
    # 1. 字体大小评分 (0-40分)
    font_score = calculate_font_score(paragraph)
    
    # 2. 加粗评分 (0-20分)
    bold_score = 20 if is_bold(paragraph) else 0
    
    # 3. 文本模式评分 (0-25分)
    pattern_score = calculate_pattern_score(paragraph.text)
    
    # 4. 段落长度评分 (0-10分)
    length_score = calculate_length_score(paragraph.text)
    
    # 5. 格式一致性评分 (0-5分)
    consistency_score = calculate_consistency_score(paragraph, context)
    
    total_score = font_score + bold_score + pattern_score + length_score + consistency_score
    
    # 推测标题级别
    level = infer_title_level(font_score, pattern_score)
    
    return total_score, level
```

## 标题层次推断

### 层级推断规则

```python
def infer_title_level(font_score, pattern_score):
    """
    根据字体和模式特征推断标题级别
    
    Returns:
        str: 'chapter' | 'level1' | 'level2' | 'level3'
    """
    if font_score >= 35:  # 大字号（22pt+）
        return 'chapter'
    elif font_score >= 25:  # 中字号（17-18pt）
        return 'level1'
    elif font_score >= 15:  # 中小字号（14-16pt）
        return 'level2'
    else:
        return 'level3'
```

### 层次关系验证

- **父子关系**：子标题通常紧跟父标题
- **同级识别**：同级标题具有相似的特征（字体、模式）
- **跳跃检测**：检测并修正异常的层级跳跃

## 实现架构

```
TitleExtractor
├── FeatureAnalyzer          # 特征分析器
│   ├── FontAnalyzer         # 字体特征分析
│   ├── PatternAnalyzer      # 文本模式分析
│   └── StructureAnalyzer    # 结构特征分析
├── ScoreEngine             # 评分引擎
│   ├── calculate_font_score()
│   ├── calculate_pattern_score()
│   └── calculate_total_score()
├── LevelInferencer         # 层级推断器
│   ├── infer_level()
│   └── validate_hierarchy()
└── TitleOrganizer          # 标题组织器
    ├── build_tree()
    └── filter_min_granularity()
```

## 关键优势

### 1. 不依赖硬编码模式
- 通过评分系统综合判断，而非简单的if-else堆砌
- 模式匹配作为辅助验证，而非核心依据

### 2. 自适应性强
- 可根据文档风格动态调整评分权重
- 支持不同字体大小和排版风格的文档

### 3. 可解释性好
- 每个标题都有清晰的评分依据
- 便于调试和优化

### 4. 可扩展性强
- 可以轻松添加新的特征维度
- 权重可配置，适应不同文档类型

## 实现步骤

1. **特征提取器**：提取字体的各类特征（大小、加粗、颜色等）
2. **模式识别器**：使用正则表达式识别常见标题模式
3. **评分引擎**：根据权重计算综合评分
4. **层级推断器**：基于评分推断标题层级
5. **结构验证器**：验证和修正标题层次关系
6. **结果过滤器**：根据需求过滤最小粒度标题

## 预期效果

- 提取所有级别的标题（最小粒度）
- 自动识别标题层次关系
- 适应不同文档格式和风格
- 准确率 > 90%